{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Settings</h1>
</div>

<div class="row">
    <!-- Sidebar Navigation -->
    <div class="col-md-3 mb-4">
        <div class="list-group sticky-top border-0 rounded-3 overflow-hidden" style="top: 20px;" id="settings-list-tab"
            role="tablist">
            <a class="list-group-item list-group-item-action border-0 py-3 active" id="list-general-list"
                data-bs-toggle="list" href="#list-general" role="tab" aria-controls="list-general">
                <i class="bi bi-sliders me-2"></i> General
            </a>
            <a class="list-group-item list-group-item-action border-0 py-3" id="list-filters-list" data-bs-toggle="list"
                href="#list-filters" role="tab" aria-controls="list-filters">
                <i class="bi bi-funnel me-2"></i> Filters
            </a>
            <a class="list-group-item list-group-item-action border-0 py-3" id="list-data-list" data-bs-toggle="list"
                href="#list-data" role="tab" aria-controls="list-data">
                <i class="bi bi-database-down me-2"></i> Data Management
            </a>
            <a class="list-group-item list-group-item-action border-0 py-3" id="list-logs-list" data-bs-toggle="list"
                href="#list-logs" role="tab" aria-controls="list-logs">
                <i class="bi bi-journal-text me-2"></i> Logs
            </a>
        </div>
    </div>

    <!-- Content Area -->
    <div class="col-md-9">
        <div class="tab-content" id="nav-tabContent">

            <!-- General Settings -->
            <div class="tab-pane fade show active" id="list-general" role="tabpanel"
                aria-labelledby="list-general-list">

                <!-- Appearance -->
                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="mb-0 fw-bold">Appearance</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="btn-group w-100" role="group" aria-label="Theme selection">
                            <input type="radio" class="btn-check" name="theme" id="theme-light" value="light"
                                autocomplete="off">
                            <label class="btn btn-outline-secondary" for="theme-light">
                                <i class="bi bi-sun me-2"></i>Light
                            </label>

                            <input type="radio" class="btn-check" name="theme" id="theme-dark" value="dark"
                                autocomplete="off">
                            <label class="btn btn-outline-secondary" for="theme-dark">
                                <i class="bi bi-moon-stars me-2"></i>Dark
                            </label>

                            <input type="radio" class="btn-check" name="theme" id="theme-auto" value="auto"
                                autocomplete="off">
                            <label class="btn btn-outline-secondary" for="theme-auto">
                                <i class="bi bi-circle-half me-2"></i>Auto
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Scanning Schedule -->
                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="mb-0 fw-bold">Scanning Schedule</h5>
                    </div>
                    <div class="card-body p-4">
                        <form hx-post="/settings/schedule" hx-target="#schedule-message" hx-swap="innerHTML">
                            <label class="form-label text-xs text-uppercase text-muted fw-bold">Interval
                                (minutes)</label>
                            <div class="mb-2">
                                <input type="number" class="form-control" name="schedule_interval"
                                    value="{{ schedule_interval }}">
                            </div>
                            {% if next_scan_time %}
                            <div class="text-muted small mb-3">
                                <i class="bi bi-clock me-1"></i> Next Scan: {{ next_scan_time }}
                            </div>
                            {% endif %}
                            <div class="form-text text-muted mb-3">Set to 0 to disable automatic background scanning.
                            </div>
                            <button class="btn btn-primary" type="submit">Save Schedule</button>
                            <div id="schedule-message" class="mt-2"></div>
                        </form>
                    </div>
                </div>

                <!-- Telegram -->
                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="mb-0 fw-bold">Telegram Notifications</h5>
                    </div>
                    <div class="card-body p-4">
                        <form hx-post="/settings/telegram" hx-target="#telegram-message" hx-swap="innerHTML">
                            <div class="mb-3">
                                <label class="form-label text-xs text-uppercase text-muted fw-bold">Bot Token</label>
                                <input type="text" class="form-control" name="telegram_token"
                                    value="{{ telegram_token }}">
                            </div>
                            <div class="mb-4">
                                <label class="form-label text-xs text-uppercase text-muted fw-bold">Chat ID</label>
                                <input type="text" class="form-control" name="telegram_chat_id"
                                    value="{{ telegram_chat_id }}">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                                <button class="btn btn-outline-secondary" hx-post="/settings/telegram/test"
                                    hx-target="#telegram-message" hx-swap="innerHTML">Test Notification</button>
                            </div>
                            <div id="telegram-message" class="mt-2"></div>
                        </form>
                    </div>
                </div>

                <!-- System (yt-dlp) -->
                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="mb-0 fw-bold">System</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <h6 class="fw-bold mb-0">yt-dlp</h6>
                                <span class="badge text-bg-light border">{{ yt_dlp_version }}</span>
                            </div>
                            <div class="text-muted small">Updated {{ yt_dlp_last_updated }}</div>
                        </div>
                        <div id="ytdlp-message" class="mb-3"></div>

                        <form hx-post="/settings/autoupdate" hx-target="#autoupdate-message" hx-swap="innerHTML">
                            <div class="mb-4 form-check">
                                <input type="checkbox" class="form-check-input" id="autoUpdateCheck"
                                    name="yt_dlp_auto_update" {% if yt_dlp_auto_update=='true' %}checked{% endif %}>
                                <label class="form-check-label fw-medium" for="autoUpdateCheck">Automatic Updates
                                    (Daily)</label>
                                <div class="form-text text-muted">Restart required to take effect.</div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                                <button class="btn btn-outline-secondary" hx-post="/settings/update-ytdlp"
                                    hx-swap="innerHTML" hx-target="#ytdlp-message">
                                    Update Now
                                </button>
                            </div>
                            <div id="autoupdate-message" class="mt-2"></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="tab-pane fade" id="list-filters" role="tabpanel" aria-labelledby="list-filters-list">
                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="mb-0 fw-bold">Global Blacklist</h5>
                    </div>
                    <div class="card-body p-4">
                        <p class="text-muted small mb-3">Comma-separated keywords. Videos containing these words in the
                            title
                            will be ignored automatically.</p>
                        <form hx-post="/settings/blacklist" hx-target="#blacklist-message" hx-swap="innerHTML">
                            <div class="mb-3">
                                <textarea class="form-control" name="blacklist" rows="5"
                                    placeholder="e.g. vr, compilation">{{ blacklist }}</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Blacklist</button>
                            <div id="blacklist-message" class="mt-2"></div>
                        </form>
                    </div>
                </div>

                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="mb-0 fw-bold">Global Whitelist</h5>
                    </div>
                    <div class="card-body p-4">
                        <p class="text-muted small mb-3">Comma-separated keywords. If set, ONLY videos containing these
                            words
                            will be downloaded (unless overridden by performer settings).</p>
                        <form hx-post="/settings/whitelist" hx-target="#whitelist-message" hx-swap="innerHTML">
                            <div class="mb-3">
                                <textarea class="form-control" name="whitelist" rows="5"
                                    placeholder="e.g. 4k, exclusive">{{ whitelist }}</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Whitelist</button>
                            <div id="whitelist-message" class="mt-2"></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="tab-pane fade" id="list-data" role="tabpanel" aria-labelledby="list-data-list">

                <!-- Local Storage -->
                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="mb-0 fw-bold">Local Storage</h5>
                    </div>
                    <div class="card-body p-4">
                        <form hx-post="/settings/localpath" hx-target="#localpath-message" hx-swap="innerHTML">
                            <div class="mb-3">
                                <label class="form-label text-xs text-uppercase text-muted fw-bold">Default Download
                                    Directory</label>
                                <input type="text" class="form-control" name="local_scan_path"
                                    value="{{ local_scan_path }}" placeholder="/path/to/videos">
                                <div class="form-text">All videos will be downloaded here unless an override is set
                                    below.</div>
                            </div>

                            <div class="mb-3">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#siteOverrides" aria-expanded="false" aria-controls="siteOverrides">
                                    <i class="bi bi-folder-plus me-1"></i> Configure Site-Specific Paths
                                </button>
                            </div>

                            <div class="collapse mb-3" id="siteOverrides">
                                <div class="card card-body bg-site-overrides border-0">
                                    <div class="mb-3">
                                        <label
                                            class="form-label text-xs text-uppercase text-muted fw-bold">Pornhub</label>
                                        <input type="text" class="form-control form-control-sm"
                                            name="local_scan_path_pornhub" value="{{ local_scan_path_pornhub }}"
                                            placeholder="Optional override">
                                    </div>
                                    <div class="mb-3">
                                        <label
                                            class="form-label text-xs text-uppercase text-muted fw-bold">xHamster</label>
                                        <input type="text" class="form-control form-control-sm"
                                            name="local_scan_path_xhamster" value="{{ local_scan_path_xhamster }}"
                                            placeholder="Optional override">
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label text-xs text-uppercase text-muted fw-bold">X</label>
                                        <input type="text" class="form-control form-control-sm" name="local_scan_path_x"
                                            value="{{ local_scan_path_x }}" placeholder="Optional override">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4 form-check">
                                <input type="checkbox" class="form-check-input" id="local_check_existing"
                                    name="local_check_existing" {% if local_check_existing=='true' %}checked{% endif %}>
                                <label class="form-check-label fw-medium" for="local_check_existing">Check for existing
                                    videos in
                                    this directory during scan</label>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Path</button>
                            <div id="localpath-message" class="mt-2"></div>
                        </form>
                    </div>
                </div>

                <!-- Stash -->
                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="mb-0 fw-bold">Stash Integration</h5>
                    </div>
                    <div class="card-body p-4">
                        <form hx-post="/settings/stash" hx-target="#stash-message" hx-swap="innerHTML">
                            <div class="mb-3">
                                <label class="form-label text-xs text-uppercase text-muted fw-bold">Stash GraphQL
                                    URL</label>
                                <input type="text" class="form-control" name="stash_url" value="{{ stash_url }}"
                                    placeholder="http://localhost:9999/graphql">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-xs text-uppercase text-muted fw-bold">API Key</label>
                                <input type="password" class="form-control" name="stash_api_key"
                                    value="{{ stash_api_key }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-xs text-uppercase text-muted fw-bold">Path Mapping</label>
                                <input type="text" class="form-control" name="stash_path_mapping"
                                    value="{{ stash_path_mapping }}" placeholder="/Volumes/media=/mnt/media">
                                <div class="form-text">Format: <code>LocalPath=RemotePath</code>. Maps local paths to
                                    Stash server paths.</div>
                            </div>
                            <div class="mb-4 form-check">
                                <input type="checkbox" class="form-check-input" id="stash_check_existing"
                                    name="stash_check_existing" {% if stash_check_existing=='true' %}checked{% endif %}>
                                <label class="form-check-label fw-medium" for="stash_check_existing">Check for existing
                                    videos in
                                    Stash</label>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                                <button class="btn btn-outline-secondary" hx-post="/settings/stash/test"
                                    hx-target="#stash-message" hx-swap="innerHTML">Test Connection</button>
                            </div>
                            <div id="stash-message" class="mt-2"></div>
                        </form>
                    </div>
                </div>

                <!-- Cookies -->
                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold">Cookies</h5>
                            {% if cookies_exist %}
                            <span class="badge bg-success-subtle text-success border border-success-subtle">
                                <i class="bi bi-check-circle me-1"></i> Uploaded
                            </span>
                            {% else %}
                            <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">
                                <i class="bi bi-x-circle me-1"></i> Not Found
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <p class="text-muted small mb-3">Upload <code>cookies.txt</code> for authenticated scraping</p>
                        <form hx-post="/settings/cookies" hx-encoding="multipart/form-data"
                            hx-target="#cookies-message">
                            <div class="mb-3">
                                <input type="file" class="form-control" name="file" accept=".json,.txt" required>
                            </div>
                            <button class="btn btn-primary" type="submit">Upload Cookies</button>
                            <div id="cookies-message" class="mt-2"></div>
                        </form>
                    </div>
                </div>

                <!-- Export/Import -->
                <div class="card border-0 mb-4">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="mb-0 fw-bold">Backup & Restore</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <h6 class="fw-bold mb-2">Export Data</h6>
                            <p class="text-muted small mb-3">Download a JSON backup of all performers, keywords, and
                                ignored
                                videos.</p>
                            <a href="/settings/export" class="btn btn-primary">
                                Export Performers
                            </a>
                        </div>
                        <hr class="text-muted opacity-25">
                        <div class="mt-4">
                            <h6 class="fw-bold mb-2">Import Data</h6>
                            <p class="text-muted small mb-3">Upload a JSON backup to merge with existing data.</p>
                            <form hx-post="/settings/import" hx-encoding="multipart/form-data"
                                hx-target="#import-result">
                                <div class="mb-3">
                                    <input type="file" class="form-control" name="file" accept=".json" required>
                                </div>
                                <button class="btn btn-primary" type="submit">
                                    Import Performers
                                </button>
                                <div id="import-result"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="tab-pane fade" id="list-logs" role="tabpanel" aria-labelledby="list-logs-list">
                <div class="card border-0 mb-4">
                    <div
                        class="card-header bg-transparent border-0 pt-4 px-4 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                        <h5 class="mb-0 fw-bold">Application Logs</h5>
                        <div class="d-flex gap-2 w-100 w-md-auto ms-md-auto">
                            <button class="btn btn-sm border" hx-get="/settings/logs" hx-target="#log-viewer"
                                hx-swap="innerHTML">
                                <i class="bi bi-arrow-clockwise me-1 d-none d-md-inline"></i> Refresh
                            </button>
                            <button class="btn btn-sm border text-danger" hx-post="/settings/logs/clear"
                                hx-target="#log-viewer" hx-swap="innerHTML">
                                <i class="bi bi-trash me-1 d-none d-md-inline"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="bg-body-tertiary log-container p-3 rounded font-monospace small"
                            style="height: 500px; overflow-y: auto;">
                            <pre id="log-viewer" class="m-0" hx-get="/settings/logs"
                                hx-trigger="load">Loading logs...</pre>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const themeRadios = document.querySelectorAll('input[name="theme"]');
        const savedTheme = localStorage.getItem('theme') || 'auto';

        // Set initial state
        const initialRadio = document.getElementById(`theme-${savedTheme}`);
        if (initialRadio) initialRadio.checked = true;

        // Handle changes
        themeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    const newTheme = e.target.value;
                    localStorage.setItem('theme', newTheme);

                    // Dispatch custom event for base.html to pick up
                    window.dispatchEvent(new CustomEvent('themeChanged', {
                        detail: { theme: newTheme }
                    }));
                }
            });
        });
    });
</script>
<style>
    .bg-site-overrides {
        background-color: var(--bs-tertiary-bg);
    }

    [data-bs-theme="dark"] .bg-site-overrides {
        background-color: #000 !important;
    }
</style>
{% endblock %}