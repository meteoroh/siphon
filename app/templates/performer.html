{% extends "base.html" %}

{% block content %}
<div class="mb-4">
    <div
        class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-3">
        <div>
            <h1 class="h2 mb-2 d-flex align-items-center">
                {{ performer.name }}
                <a href="{{ performer.profile_url }}" target="_blank" class="btn btn-sm btn-light rounded-circle ms-2"
                    title="Open Profile"
                    style="width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center;">
                    <i class="bi bi-box-arrow-up-right text-muted" style="font-size: 0.8rem;"></i>
                </a>
            </h1>
            <div class="d-flex gap-2">
                <span
                    class="badge rounded-pill {{ 'bg-warning-subtle text-warning-emphasis' if performer.site == 'pornhub' else 'bg-danger-subtle text-danger-emphasis' }} border border-0">
                    {{ performer.site }}
                </span>
                <span class="badge bg-secondary-subtle text-secondary-emphasis border border-0 rounded-pill">{{
                    performer.type }}</span>
            </div>
        </div>
        <div class="d-flex gap-2 w-100 w-md-auto ms-md-auto">
            <div id="scan-container-{{ performer.id }}">
                <button class="btn btn-primary" hx-post="/scan/{{ performer.id }}"
                    hx-target="#scan-container-{{ performer.id }}" hx-swap="innerHTML">
                    <i class="bi bi-arrow-repeat me-1 d-none d-md-inline"></i> Scan Now
                </button>
            </div>
            <button class="btn btn-white border" type="button" data-bs-toggle="collapse"
                data-bs-target="#settingsCollapse">
                <i class="bi bi-gear me-1 d-none d-md-inline"></i> Settings
            </button>
        </div>
    </div>

    <div class="collapse mb-5" id="settingsCollapse">
        <div class="card border-0">
            <div class="card-header bg-white border-0 pt-4 px-4">
                <h5 class="mb-0">Performer Settings</h5>
            </div>
            <div class="card-body p-4">
                <form hx-post="/performers/{{ performer.id }}/settings" hx-swap="innerHTML"
                    hx-target="#settings-message">
                    <div class="mb-4 form-check">
                        <input type="checkbox" class="form-check-input" id="scheduled_scan_enabled"
                            name="scheduled_scan_enabled" {% if performer.scheduled_scan_enabled %}checked{% endif %}>
                        <label class="form-check-label fw-medium" for="scheduled_scan_enabled">Enable Scheduled
                            Scanning</label>
                        <div class="form-text text-muted">If unchecked, this performer will be skipped during background
                            scans.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-xs text-uppercase text-muted fw-bold">Blacklist
                                Keywords</label>
                            <input type="text" class="form-control" name="blacklist_keywords"
                                value="{{ performer.blacklist_keywords or '' }}" placeholder="e.g. vr, compilation">
                            <div class="form-text">Videos containing these words will be ignored automatically.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-xs text-uppercase text-muted fw-bold">Whitelist
                                Keywords</label>
                            <input type="text" class="form-control" name="whitelist_keywords"
                                value="{{ performer.whitelist_keywords or '' }}" placeholder="e.g. 4k, exclusive">
                            <div class="form-text">If set, ONLY videos containing these words will be downloaded.</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                        <div id="settings-message" class="d-block mt-2"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div
        class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-3">
        <h3 class="h4 mb-0">Videos</h3>

        <div class="btn-group w-100 w-md-auto ms-md-auto" role="group">
            <input type="radio" class="btn-check" name="status-filter" id="filter-all" value="all" checked
                onclick="currentFilterStatus='all'; filterVideos('all')">
            <label class="btn btn-outline-secondary btn-sm flex-fill flex-md-grow-0" for="filter-all">All ({{
                videos|length }})</label>

            <input type="radio" class="btn-check" name="status-filter" id="filter-new" value="new"
                onclick="currentFilterStatus='new'; filterVideos('new')">
            <label class="btn btn-outline-success btn-sm flex-fill flex-md-grow-0" for="filter-new">New ({{
                videos|selectattr('status',
                'equalto', 'new')|list|length }})</label>

            <input type="radio" class="btn-check" name="status-filter" id="filter-downloaded" value="downloaded"
                onclick="currentFilterStatus='downloaded'; filterVideos('downloaded')">
            <label class="btn btn-outline-primary btn-sm flex-fill flex-md-grow-0" for="filter-downloaded">Downloaded
                ({{ videos|selectattr('status', 'equalto', 'downloaded')|list|length }})</label>

            <input type="radio" class="btn-check" name="status-filter" id="filter-ignored" value="ignored"
                onclick="currentFilterStatus='ignored'; filterVideos('ignored')">
            <label class="btn btn-outline-danger btn-sm flex-fill flex-md-grow-0" for="filter-ignored">Ignored ({{
                videos|selectattr('status',
                'equalto', 'ignored')|list|length }})</label>
        </div>
    </div>
</div>
<style>
    /* CSS-based filtering to prevent blink effect */
    tbody.view-new tr:not([data-status="new"]) {
        display: none !important;
    }

    tbody.view-downloaded tr:not([data-status="downloaded"]) {
        display: none !important;
    }

    tbody.view-ignored tr:not([data-status="ignored"]) {
        display: none !important;
    }

    /* Responsive video title truncation */
    .video-title {
        min-width: 200px;
        max-width: 300px;
        /* Default for mobile */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    @media (min-width: 768px) {
        .video-title {
            max-width: 500px;
            /* Tablet and Desktop */
        }
    }

    /* view-all shows everything, so no rule needed */
</style>

<div class="card border-0 mb-4">
    <div class="card-header bg-white border-bottom border-light py-3">
        <div class="d-flex gap-2">
            <button id="btn-batch-download" class="btn btn-sm btn-white border" hx-post="/download/batch"
                hx-target="#batch-message" hx-include="#batch-form" disabled>
                <span class="spinner-border spinner-border-sm htmx-indicator" role="status" aria-hidden="true"></span>
                <i class="bi bi-download me-1 d-none d-md-inline"></i> <span class="btn-text">Download</span>
            </button>
            <button id="btn-batch-ignore" class="btn btn-sm btn-white border" hx-post="/ignore/batch"
                hx-target="#batch-message" hx-include="#batch-form" disabled>
                <span class="spinner-border spinner-border-sm htmx-indicator" role="status" aria-hidden="true"></span>
                <i class="bi bi-x-circle me-1 d-none d-md-inline"></i> <span class="btn-text">Ignore</span>
            </button>
            <button id="btn-batch-unignore" class="btn btn-sm btn-white border" hx-post="/unignore/batch"
                hx-target="#batch-message" hx-include="#batch-form" disabled>
                <span class="spinner-border spinner-border-sm htmx-indicator" role="status" aria-hidden="true"></span>
                <i class="bi bi-arrow-counterclockwise me-1 d-none d-md-inline"></i> <span
                    class="btn-text">Unignore</span>
            </button>
        </div>
    </div>

    <form id="batch-form">
        <div id="batch-message"></div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light align-middle">
                    <tr>
                        <th class="ps-4 py-3" style="width: 40px;"><input type="checkbox" class="form-check-input"
                                onclick="toggleAll(this)"></th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                            style="font-size: 0.75rem; letter-spacing: 0.5px;">Title</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                            style="font-size: 0.75rem; letter-spacing: 0.5px;">Duration</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                            style="font-size: 0.75rem; letter-spacing: 0.5px;">Status</th>
                        <th class="text-end text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 pe-4"
                            style="font-size: 0.75rem; letter-spacing: 0.5px;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for video in videos %}
                    {% include 'components/video_row.html' %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-camera-video display-4 opacity-25 mb-3"></i>
                            <p>No videos found yet. Try scanning.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

<script>
    let currentFilterStatus = 'all';

    function filterVideos(status) {
        currentFilterStatus = status;
        const tbody = document.querySelector('tbody');

        // Remove all view classes
        tbody.classList.remove('view-all', 'view-new', 'view-downloaded', 'view-ignored');

        // Add current view class
        tbody.classList.add(`view-${status}`);

        // Uncheck hidden checkboxes to avoid confusion
        // We need a small delay or check visibility because CSS change is instant but querySelector might be fast?
        // Actually, we can just select based on the logic: if we are in view-new, uncheck anything not new.

        if (status !== 'all') {
            const hiddenCheckboxes = document.querySelectorAll(`tbody tr:not([data-status="${status}"]) input[type="checkbox"]`);
            hiddenCheckboxes.forEach(cb => cb.checked = false);
        }

        updateBatchButtons();
    }

    function toggleAll(source) {
        // Only select visible checkboxes
        const checkboxes = document.querySelectorAll('tbody tr:not([style*="display: none"]) input[name="video_ids"]');
        checkboxes.forEach(cb => cb.checked = source.checked);
        updateBatchButtons(); // Call updateBatchButtons after toggling all
    }

    function updateBatchButtons() {
        const checkedBoxes = document.querySelectorAll('input[name="video_ids"]:checked');

        let newCount = 0;
        let ignoredCount = 0;

        checkedBoxes.forEach(cb => {
            const row = cb.closest('tr');
            const status = row.dataset.status;
            if (status === 'new') newCount++;
            if (status === 'ignored') ignoredCount++;
        });

        const btnDownload = document.getElementById('btn-batch-download');
        const btnIgnore = document.getElementById('btn-batch-ignore');
        const btnUnignore = document.getElementById('btn-batch-unignore');

        if (newCount > 0) {
            btnDownload.disabled = false;
            btnDownload.querySelector('.btn-text').textContent = `Download (${newCount})`;
            btnIgnore.disabled = false;
            btnIgnore.querySelector('.btn-text').textContent = `Ignore (${newCount})`;
        } else {
            btnDownload.disabled = true;
            btnDownload.querySelector('.btn-text').textContent = 'Download';
            btnIgnore.disabled = true;
            btnIgnore.querySelector('.btn-text').textContent = 'Ignore';
        }

        if (ignoredCount > 0) {
            btnUnignore.disabled = false;
            btnUnignore.querySelector('.btn-text').textContent = `Unignore (${ignoredCount})`;
        } else {
            btnUnignore.disabled = true;
            btnUnignore.querySelector('.btn-text').textContent = 'Unignore';
        }
    }

    // Listen for checkbox changes
    document.addEventListener('change', function (e) {
        if (e.target.name === 'video_ids') {
            updateBatchButtons();
        }
    });

    // Initial call to set button states on page load
    document.addEventListener('DOMContentLoaded', updateBatchButtons);

    // Re-apply filter after HTMX swaps (e.g. batch actions, ignore/unignore)
    document.body.addEventListener('htmx:afterSwap', function (evt) {
        updateBatchButtons();
        // Re-run filter logic to hide/show rows based on new status
        // With CSS filtering, we just need to ensure the class is set, which it should be.
        // But if we just swapped a row, it might have the wrong display style if we were using inline styles before.
        // Since we are switching to CSS classes, we should remove any inline display styles from rows if any exist (legacy).
        // But wait, the new rows come from server without inline styles.
        // The only thing is to make sure the tbody has the correct class. It should persist.
        // However, we might need to uncheck checkboxes if a row disappeared.
        filterVideos(currentFilterStatus);
    });
</script>
{% endblock %}
```