{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Performers</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPerformerModal">
        Add Performer
    </button>
</div>

<form action="/performers" method="get" class="mb-4">
    <div class="input-group">
        <input type="text" class="form-control" name="q" placeholder="Search performers..."
            value="{{ request.args.get('q', '') }}">
        <button class="btn btn-outline-secondary" type="submit">Search</button>
    </div>
</form>

<div class="row" id="performers-list">
    {% for performer in performers %}
    <div class="col-md-4 mb-4">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3">
                <span
                    class="badge rounded-pill {{ 'bg-warning text-dark' if performer.site == 'pornhub' else 'bg-danger' }}">
                    {{ performer.site }}
                </span>
                <div class="dropdown">
                    <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <button class="dropdown-item" data-bs-toggle="modal"
                                data-bs-target="#editPerformerModal{{ performer.id }}">
                                <i class="bi bi-pencil me-2"></i>Edit
                            </button>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <button class="dropdown-item text-danger" hx-delete="/performers/{{ performer.id }}/delete"
                                hx-confirm="Are you sure you want to delete {{ performer.name }}?"
                                hx-target="closest .col-md-4" hx-swap="outerHTML">
                                <i class="bi bi-trash me-2"></i>Delete
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card-body text-center pt-0">
                <h5 class="card-title fw-bold mb-1 text-truncate" title="{{ performer.name }}">{{ performer.name }}</h5>
                <p class="text-muted small mb-3">{{ performer.type }}</p>

                <div id="performer-stats-{{ performer.id }}" class="mb-4 p-3 bg-light rounded-3">
                    {% set new_count = performer.videos.filter_by(status='new').count() %}
                    <div class="display-6 fw-bold {{ 'text-success' if new_count > 0 else 'text-muted' }}">
                        {{ new_count }}
                    </div>
                    <div class="small text-uppercase fw-bold text-muted"
                        style="font-size: 0.7rem; letter-spacing: 1px;">New Videos</div>
                    <div class="mt-2 pt-2 border-top">
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            {{ performer.last_scan.strftime('%Y-%m-%d') if performer.last_scan else 'Never' }}
                        </small>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <a href="/performers/{{ performer.id }}" class="btn btn-outline-primary">
                        <i class="bi bi-collection-play me-1"></i> View Videos
                    </a>
                    <button class="btn btn-primary" hx-post="/scan/{{ performer.id }}"
                        hx-target="#performer-stats-{{ performer.id }}" hx-swap="innerHTML">
                        <i class="bi bi-arrow-repeat me-1"></i> Scan Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Performer Modal -->
    <div class="modal fade" id="editPerformerModal{{ performer.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Performer: {{ performer.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form hx-post="/performers/{{ performer.id }}/edit" hx-swap="none"
                        onsubmit="bootstrap.Modal.getInstance(document.getElementById('editPerformerModal{{ performer.id }}')).hide(); setTimeout(() => location.reload(), 500);">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" value="{{ performer.name }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Site</label>
                            <select class="form-select" name="site">
                                <option value="pornhub" {% if performer.site=='pornhub' %}selected{% endif %}>Pornhub
                                </option>
                                <option value="xhamster" {% if performer.site=='xhamster' %}selected{% endif %}>xHamster
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="type">
                                <option value="model" {% if performer.type=='model' %}selected{% endif %}>Model</option>
                                <option value="pornstar" {% if performer.type=='pornstar' %}selected{% endif %}>Pornstar
                                </option>
                                <option value="creator" {% if performer.type=='creator' %}selected{% endif %}>Creator
                                </option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Performer Modal -->
<div class="modal fade" id="addPerformerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Performer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form hx-post="/performers" hx-target="#performers-list" hx-swap="beforeend"
                    onsubmit="bootstrap.Modal.getInstance(document.getElementById('addPerformerModal')).hide()">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ID</label>
                        <input type="text" class="form-control" name="id" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Site</label>
                        <select class="form-select" name="site">
                            <option value="pornhub">Pornhub</option>
                            <option value="xhamster">xHamster</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" name="type">
                            <option value="model">Model</option>
                            <option value="pornstar">Pornstar</option>
                            <option value="creator">Creator</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}